var V=h=>{throw TypeError(h)};var A=(h,f,T)=>f.has(h)||V("Cannot "+T);var l=(h,f,T)=>(A(h,f,"read from private field"),T?T.call(h):f.get(h)),C=(h,f,T)=>f.has(h)?V("Cannot add the same private member more than once"):f instanceof WeakSet?f.add(h):f.set(h,T),S=(h,f,T,_)=>(A(h,f,"write to private field"),_?_.call(h,T):f.set(h,T),T),y=(h,f,T)=>(A(h,f,"access private method"),T);(function(){"use strict";var O,j,$,g,J,L,E,p,v,w,M,k,b;let h,f,T=!1;const _=getComputedStyle(document.documentElement).getPropertyValue("--card-gap-between").slice(0,-2);function P(){const e=document.querySelector(".task-wrapper").clientHeight,t=document.querySelector(".task-container.primary"),s=t.scrollHeight,n=document.querySelector(".task-container.secondary");if(s>e&&!T){n.style.display="block";const a=_settings.scrollSpeed.toString();let r=parseInt(a,10),c=s+parseInt(_,10)*2,u={duration:c/r*1e3,iterations:1,easing:"linear"},d=[{transform:"translateY(0)"},{transform:`translateY(-${c}px)`}],m=[{transform:"translateY(0)"},{transform:`translateY(-${c}px)`}];h=t.animate(d,u),f=n.animate(m,u),T=!0,K()}else s<=e&&(n.style.display="none",W())}function W(){h&&h.cancel(),f&&f.cancel(),T=!1}function K(){h&&(h.addEventListener("finish",q),h.addEventListener("cancel",q))}function q(){T=!1,P()}function D(o,e){o.innerText!==e&&(o.style.opacity="0",setTimeout(()=>{o.textContent=e,o.style.opacity="1"},700))}function Y(o){const e=document.querySelector(":root");for(let[t,s]of Object.entries(o))t.includes("FontFamily")&&z(s),e.style.setProperty(Q(t),s)}function z(o){window.WebFont.load({google:{families:[`${o}:100,400,700`]}})}function Q(o){return`--${o.replace(/([A-Z])/g,"-$1").toLowerCase()}`}class N{constructor(e,t){this.username=this.validateUsername(e),this.userColor=(t==null?void 0:t.userColor)||"",this.tasks=[]}validateUsername(e){if(typeof e!="string")throw new Error("Username must be of type string");if(e=e.trim(),e.length===0)throw new Error("Username invalid");return e}addTask(e){return this.tasks.push(e),e}editTask(e,t){let s=this.getTask(e);return s?(s.setDescription(t),s):null}completeTask(e){let t=this.getTask(e);return t?(t.setCompletionStatus(!0),t):null}deleteTask(e){const t=[].concat(e).filter(n=>this.validTaskIndex(n)),s=[];return this.tasks=this.tasks.filter((n,a)=>t.includes(a)?(s.push(n),!1):!0),s}removeCompletedTasks(){const e=[];return this.tasks=this.tasks.filter(t=>t.isComplete()?(e.push(t),!1):!0),e}getTask(e){return this.validTaskIndex(e)?this.tasks[e]:null}getTasks(){return this.tasks}validTaskIndex(e){return!(typeof e!="number"||isNaN(e)||e<0||e>=this.tasks.length)}}class R{constructor(e){C(this,O);this.description=this.validateDescription(e),this.id=y(this,O,j).call(this),this.completionStatus=!1}validateDescription(e){if(typeof e!="string")throw new Error("Task description must be of type string");if(e=e.trim(),e.length===0)throw new Error("Task description invalid");return e}setDescription(e){this.description=this.validateDescription(e)}isComplete(){return this.completionStatus}setCompletionStatus(e){if(typeof e!="boolean")throw new Error("Completion status must be of type boolean");this.completionStatus=e}}O=new WeakSet,j=function(){const e=new Date,t=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0"),r=String(e.getMilliseconds()).padStart(3,"0"),c=Math.floor(Math.random()*1e4);return`${t}${s}${n}${a}${r}${c}`};class Z{constructor(e="userList"){C(this,g);C(this,$);S(this,$,e),this.tasksCompleted=0,this.totalTasks=0,this.users=y(this,g,J).call(this)}getUser(e){return this.users.find(t=>t.username===e)}getAllUsers(){return this.users}createUser(e,t){if(this.getUser(e))throw new Error(`${e} already exists`);const s=new N(e,t);return this.users.push(s),s}addUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} does not exist`);const n=[].concat(t),a=[];return n.forEach(r=>{a.push(s.addTask(new R(r))),this.totalTasks++}),y(this,g,L).call(this),a}editUserTask(e,t,s){const n=this.getUser(e);if(!n)throw new Error(`${e} has no tasks`);const a=n.editTask(t,s);if(!a)throw new Error(`Task ${t} not found`);return y(this,g,L).call(this),a}completeUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`User ${e} not found`);const n=[].concat(t).reduce((a,r)=>{const c=s.getTask(r);return c&&(c.isComplete()||(c.setCompletionStatus(!0),this.tasksCompleted++),a.push(c)),a},[]);return y(this,g,L).call(this),n}deleteUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`User ${e} not found`);const n=[].concat(t),a=s.deleteTask(n);return s.getTasks().length===0&&this.deleteUser(e),this.decreaseTaskCount(a),y(this,g,L).call(this),a}checkUserTasks(e,t="incomplete"){const s=this.getUser(e);if(!s)return new Map;const n=new Map;return s.getTasks().forEach((a,r)=>{t==="incomplete"&&!a.isComplete()&&n.set(r,a),t==="complete"&&a.isComplete()&&n.set(r,a)}),n}clearUserList(){this.users=[],this.tasksCompleted=0,this.totalTasks=0,y(this,g,L).call(this)}clearDoneTasks(){let e=[];return this.users.forEach(t=>{let s=t.removeCompletedTasks();this.decreaseTaskCount(s),e=e.concat(s)}),y(this,g,L).call(this),e}deleteUser(e){const t=this.users.findIndex(a=>RegExp(`^${e}`,"i").test(a.username));if(t===-1)throw new Error(`${e} not found`);const s=this.users[t],n=this.users.splice(t,1)[0];return this.decreaseTaskCount(n.getTasks()),y(this,g,L).call(this),s}decreaseTaskCount(e){e.forEach(t=>{t.isComplete()&&this.tasksCompleted--,this.totalTasks--})}}$=new WeakMap,g=new WeakSet,J=function(){const e=[];let t=localStorage.getItem(l(this,$));return t?JSON.parse(t).forEach(s=>{const n=new N(s.username,{userColor:s.userColor});s.tasks.map(a=>{const r=n.addTask(new R(a.description));this.totalTasks++,a.completionStatus&&(r.setCompletionStatus(a.completionStatus),this.tasksCompleted++)}),e.push(n)}):localStorage.setItem(l(this,$),JSON.stringify(e)),e},L=function(){localStorage.setItem(l(this,$),JSON.stringify(this.users))};const X=document.getElementById("audioSample");class ee{constructor(e){C(this,E,null);C(this,p);C(this,v);C(this,w);C(this,M);this.userList=new Z(e),Y(_styles),S(this,p,_settings.languageCode),S(this,v,_settings.maxTasksPerUser),S(this,w,_settings.headerFeature),S(this,M,_settings.headerCustomText)}render(){this.renderTaskList(),this.renderTaskHeader()}renderTaskList(){if(this.userList.users.length===0)return;const e=document.createDocumentFragment();this.userList.getAllUsers().forEach(r=>{const c=H(r),i=c.querySelector("ol");r.tasks.forEach(u=>{const d=document.createElement("li");d.classList.add("task"),d.dataset.taskId=`${u.id}`,d.innerText=u.description,u.isComplete()&&d.classList.add("done"),i.appendChild(d)}),e.appendChild(c)});const t=e.cloneNode(!0),s=document.querySelector(".task-container.primary");s.innerHTML="",s.appendChild(t);const n=e.cloneNode(!0),a=document.querySelector(".task-container.secondary");a.innerHTML="",a.appendChild(n),P()}renderTaskHeader(){this.renderTaskCount(),l(this,w).toLowerCase()==="timer"?this.renderTimer():l(this,w).toLowerCase()==="commands"?this.renderCommandTips():l(this,w).toLowerCase()==="text"&&this.renderCustomText(l(this,M))}renderTaskCount(){let e=this.userList.tasksCompleted,t=this.userList.totalTasks;const s=document.querySelector(".task-count");s.innerText=`${e}/${t}`}renderTimer(){document.querySelector(".timer").classList.remove("hidden")}startTimer(e=0,t=10){l(this,E)&&clearInterval(l(this,E));const s=document.querySelector(".timer"),n=s.querySelector(".timer-title"),a=s.querySelector(".timer-countdown");let r=e*60;D(n,"Focus");let c=!0;const i=()=>{const u=Math.floor(r/60).toString().padStart(2,"0"),d=(r%60).toString().padStart(2,"0");a.textContent=`${u}:${d}`,r===0?(clearInterval(l(this,E)),D(n,"Break"),a.textContent="00:00",X.play(),r=t*60,c&&(S(this,E,setInterval(i,1e3)),c=!1)):r--};S(this,E,setInterval(i,1e3))}renderCommandTips(){const e=["!task","!edit","!done","!delete","!check","!help"],t=document.querySelector(".command-tips");t.classList.remove("hidden");let s=0;setInterval(()=>{const n=t.querySelector(".command-code");D(n,e[s]),s=(s+1)%e.length},6e3)}renderCustomText(e){document.querySelector(".custom-header").classList.remove("hidden"),document.querySelector(".custom-text").textContent=e}chatHandler(e,t,s,n,a){t=`!${t.toLowerCase()}`;let r="",c="";try{if(te(n))if(l(this,w).toLowerCase()==="timer"&&_adminConfig.commands.timer.includes(t)&&n.broadcaster){const[i,u]=s.split("/"),d=parseInt(i,10),m=parseInt(u,10)||10;if(isNaN(d)||d<0||isNaN(m)||m<0)throw new Error("Invalid timer duration");return this.startTimer(d,m),r=_adminConfig.responseTo[l(this,p)].timer+" ‚è≤Ô∏è",c=i,I(r,e,c)}else{if(_adminConfig.commands.clearList.includes(t))return this.userList.clearUserList(),this.clearListFromDOM(),r=_adminConfig.responseTo[l(this,p)].clearList,I(r,e,c);if(_adminConfig.commands.clearDone.includes(t))return this.userList.clearDoneTasks().forEach(({id:u})=>{this.deleteTaskFromDOM(u)}),r=_adminConfig.responseTo[l(this,p)].clearDone,I(r,e,c);if(_adminConfig.commands.clearUser.includes(t)){const i=this.userList.deleteUser(s);return this.deleteUserFromDOM(i),c=i.username,r=_adminConfig.responseTo[l(this,p)].clearUser,I(r,e,c)}}if(_userConfig.commands.addTask.includes(t)){if(s==="")throw new Error("Task description is empty");let i=this.userList.getUser(e)||this.userList.createUser(e,{userColor:a.userColor});const u=s.split(", ");i.getTasks().length+u.length>parseInt(l(this,v).toString(),10)?r=_userConfig.responseTo[l(this,p)].maxTasksAdded:(this.userList.addUserTasks(e,u).forEach(m=>{this.addTaskToDOM(i,m)}),c=u.map(m=>`üìù "${m}"`).join(", ").replace(/,([^,]*)$/," &$1"),r=_userConfig.responseTo[l(this,p)].addTask)}else if(_userConfig.commands.editTask.includes(t)){const i=s.search(new RegExp("(?<=\\d)\\s"));if(i===-1)throw new Error("Task number or description format is invalid");const u=s.slice(0,i),d=s.slice(i+1),m=this.userList.editUserTask(e,U(u),d);this.editTaskFromDOM(m),c=u,r=_userConfig.responseTo[l(this,p)].editTask}else if(_userConfig.commands.finishTask.includes(t)){const i=s.split(",").reduce((d,m)=>(U(m)>=0&&d.push(U(m)),d),[]),u=this.userList.completeUserTasks(e,i);u.forEach(({id:d})=>{this.completeTaskFromDOM(d)}),u.length===0?r=_userConfig.responseTo[l(this,p)].noTaskFound:(c=u.map(d=>`‚úÖ "${d.description}"`).join(", ").replace(/,([^,]*)$/," &$1"),r=_userConfig.responseTo[l(this,p)].finishTask)}else if(_userConfig.commands.deleteTask.includes(t))if(c=s,s.toLowerCase()==="all"){const i=this.userList.deleteUser(e);this.deleteUserFromDOM(i),r=_userConfig.responseTo[l(this,p)].deleteAll}else{const i=s.split(",").reduce((d,m)=>(U(m)>=0&&d.push(U(m)),d),[]),u=this.userList.deleteUserTasks(e,i);u.forEach(({id:d})=>{this.deleteTaskFromDOM(d)}),u.length===0?r=_userConfig.responseTo[l(this,p)].noTaskFound:r=_userConfig.responseTo[l(this,p)].deleteTask}else if(_userConfig.commands.check.includes(t)){const i=this.userList.checkUserTasks(e),u=[];for(let[d,m]of i)u.push(`üìù ${d+1}. ${m.description}`);c=u.join(" "),c===""?r=_userConfig.responseTo[l(this,p)].noTaskFound:r=_userConfig.responseTo[l(this,p)].check}else if(_userConfig.commands.help.includes(t))r=_userConfig.responseTo[l(this,p)].help;else if(_userConfig.commands.additional.includes(t))r=_userConfig.responseTo[l(this,p)].additional;else throw new Error("command not found");return I(r,e,c)}catch(i){return I(_userConfig.responseTo[l(this,p)].invalidCommand,e,i.message,!0)}}clearListFromDOM(){const e=document.querySelector(".task-container.primary"),t=document.querySelector(".task-container.secondary");e.innerHTML="",t.innerHTML="",this.renderTaskCount()}addTaskToDOM(e,t){const s=document.querySelector(".task-container.primary"),n=document.querySelector(".task-container.secondary");if(document.querySelectorAll(`[data-user="${e.username}"]`).length===0){const i=H(e),u=i.cloneNode(!0);s.appendChild(i),n.appendChild(u)}const r=document.createElement("li");r.classList.add("task"),r.dataset.taskId=`${t.id}`,r.innerText=t.description;const c=r.cloneNode(!0);s.querySelector(`[data-user="${e.username}"] .tasks`).appendChild(r),n.querySelector(`[data-user="${e.username}"] .tasks`).appendChild(c),this.renderTaskCount(),P()}editTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e.id}"]`);for(const s of t)s.innerText=e.description}completeTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e}"]`);for(const s of t)s.classList.add("done");this.renderTaskCount()}deleteTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e}"]`);for(const s of t)s.parentElement.children.length===1?s.parentElement.parentElement.remove():s.remove();this.renderTaskCount()}deleteUserFromDOM(e){const{username:t,tasks:s}=e,n=document.querySelectorAll(`[data-user="${t}"]`);for(let a of n)a.remove();this.renderTaskCount()}}E=new WeakMap,p=new WeakMap,v=new WeakMap,w=new WeakMap,M=new WeakMap;function I(o,e,t,s=!1){return{message:_settings.botResponsePrefix+o.replace("{user}",e).replace("{message}",t),error:s}}function te(o){return o.broadcaster||o.mod}function U(o){return parseInt(o,10)-1}function H({username:o,userColor:e}){const t=document.createElement("div");t.classList.add("card"),t.dataset.user=o;const s=document.createElement("div");s.classList.add("username"),s.innerText=o,s.style.color=_settings.showUsernameColor?e:"",t.appendChild(s);const n=document.createElement("ol");return n.classList.add("tasks"),t.appendChild(n),t}function se(){document.getElementById("modal").classList.remove("hidden"),document.getElementById("modal").classList.add("flex")}function re(){document.getElementById("modal").classList.remove("flex"),document.getElementById("modal").classList.add("hidden")}function ne(o){const e={command:null,parameters:null,source:null,tags:null};let t=0,s=null,n=null,a=null,r=null;if(o[t]==="@"){let i=o.indexOf(" ");s=o.slice(1,i),t=i+1}if(o[t]===":"){t+=1;let i=o.indexOf(" ",t);n=o.slice(t,i),t=i+1}let c=o.indexOf(":",t);return c===-1&&(c=o.length),a=o.slice(t,c).trim(),c!==o.length&&(t=c+1,r=o.slice(t)),e.command=oe(a),e.command===null?null:(s!==null&&(e.tags=ae(s)),e.source=ie(n),e.parameters=r,r&&r[0]==="!"&&(e.command=ce(r,e.command)),e)}function oe(o){let e=null;const t=o.split(" ");switch(t[0]){case"JOIN":case"PART":case"NOTICE":case"CLEARCHAT":case"HOSTTARGET":case"PRIVMSG":e={command:t[0],channel:t[1]};break;case"PING":e={command:t[0]};break;case"CAP":e={command:t[0],isCapRequestEnabled:t[2]==="ACK"};break;case"GLOBALUSERSTATE":e={command:t[0]};break;case"USERSTATE":case"ROOMSTATE":e={command:t[0],channel:t[1]};break;case"RECONNECT":e={command:t[0]};break;case"421":return console.error(`Unsupported IRC command: ${t[2]}`),null;case"001":e={command:t[0]};break;case"002":case"003":case"004":case"353":case"366":case"372":case"375":case"376":return null;default:return console.log(`Unexpected command: ${t[0]}`),null}return e}function ae(o){const e={"client-nonce":null,flags:null};let t={};return o.split(";").forEach(n=>{let a=n.split("="),r=a[1]===""?null:a[1];switch(a[0]){case"badges":case"badge-info":if(r){let i={};r.split(",").forEach(d=>{let m=d.split("/");i[m[0]]=m[1]}),t[a[0]]=i}else t[a[0]]=null;break;case"emotes":if(r){let i={};r.split("/").forEach(d=>{let m=d.split(":"),G=[];m[1].split(",").forEach(Te=>{let B=Te.split("-");G.push({startPosition:B[0],endPosition:B[1]})}),i[m[0]]=G}),t[a[0]]=i}else t[a[0]]=null;break;case"emote-sets":let c=r.split(",");t[a[0]]=c;break;default:e.hasOwnProperty(a[0])||(t[a[0]]=r)}}),t}function ie(o){if(o==null)return null;{let e=o.split("!");return{nick:e.length==2?e[0]:null,host:e.length==2?e[1]:e[0]}}}function ce(o,e){let s=o.slice(0+1).trim(),n=s.indexOf(" ");return n===-1?(e.botCommand=s.slice(0),e.botCommandParams=""):(e.botCommand=s.slice(0,n),e.botCommandParams=s.slice(n).trim()),e}class le{constructor(){this.events=new Map}on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}emit(e,...t){this.events.has(e)&&this.events.get(e).forEach(s=>s(...t))}off(e,t){if(this.events.has(e)){const s=this.events.get(e),n=s.indexOf(t);n!==-1&&(s.splice(n,1),s.length===0&&this.events.delete(e))}}once(e,t){const s=(...n)=>{t(...n),this.off(e,s)};this.on(e,s)}}class de extends le{constructor(t,{username:s,authToken:n,channel:a},r=WebSocket){super();C(this,k,null);C(this,b,1e3);this.url=t,this.username=s.toLowerCase(),this.channel=`#${a.toLowerCase()}`,this.authToken=n.includes("oauth:")?n:`oauth:${n}`,this.WebSocketService=r}connect(){S(this,k,new this.WebSocketService(this.url)),l(this,k).onopen=()=>{l(this,k).send("CAP REQ :twitch.tv/tags twitch.tv/commands"),l(this,k).send(`PASS ${this.authToken}`),l(this,k).send(`NICK ${this.username}`)},l(this,k).onerror=t=>(console.error("websocket error: ",t),t),l(this,k).onmessage=t=>{(t==null?void 0:t.data).trim().split(`\r
`).forEach(a=>{const r=ne(a);if(r)switch(r.command.command){case"PRIVMSG":if(r.parameters.startsWith("!")){const c=ue(r);this.emit("command",c)}break;case"PING":l(this,k).send("PONG "+r.parameters);break;case"001":l(this,k).send(`JOIN ${this.channel}`);break;case"JOIN":console.log(`Joined ${this.channel}`),S(this,b,1e3),this.emit("oauthSuccess");break;case"RECONNECT":this.disconnect(1012,"The Twitch IRC server is terminating the connection for maintenance reasons.");break;case"PART":console.error("The channel must have banned (/ban) the bot."),l(this,k).close();break;case"NOTICE":console.error(`${r.parameters}; left ${this.channel}`),this.emit("oauthError"),l(this,k).send(`PART ${this.channel}`);break}})},l(this,k).onclose=t=>{switch(t.code){case 1e3:console.log("Connection closed normally.");break;case 1006:console.error(`Connection dropped. Reconnecting in ${l(this,b)} milliseconds...`);let s=l(this,b);setTimeout(()=>{this.connect()},s),S(this,b,l(this,b)*2);break;case 1012:console.log("Switching  servers..."),this.connect();break;default:console.error(`Unhandled code: ${t.code}. Reason: ${t.reason}`)}}}say(t,s){var n;if(((n=l(this,k))==null?void 0:n.readyState)===WebSocket.OPEN){const r=[s?`@reply-parent-msg-id=${s}`:"","PRIVMSG",this.channel,`:${t}`].join(" ").trim();l(this,k).send(r)}else console.error("Connection is not open")}disconnect(t=1e3,s=""){l(this,k).close(t,s)}}k=new WeakMap,b=new WeakMap;function ue(o){var e,t;return{user:o.tags["display-name"],command:o.command.botCommand,message:o.command.botCommandParams||"",flags:{broadcaster:!!((e=o.tags.badges)!=null&&e.broadcaster),mod:!!((t=o.tags.badges)!=null&&t.moderator)},extra:{userColor:o.tags.color,messageId:o.tags.id}}}function me(o){o.emit("command",{user:"adminUser",command:"clearList",message:"",flags:{broadcaster:!0,mod:!1},extra:{userColor:"#FF0000",messageId:`${F()}`}});const e=["red","coral","springGreen","lightSeaGreen","slateBlue","hotpink","violet","orange","darkTurquoise","dodgerblue","blueviolet"],{maxTasksPerUser:t}=_settings;for(let s=1;s<=5;s++){const n=`Username${s}`,a=e[s-1];for(let r=0;r<t;r++){const c={user:n,command:"task",message:`test task description ${r===2?"longer text example":""}`,flags:{broadcaster:!0,mod:!1},extra:{userColor:a,messageId:`${F()}`}};setTimeout(()=>{o.emit("command",c)},1e3*s+r*100)}setTimeout(()=>{const r={user:n,command:"done",message:"1",flags:{broadcaster:!0,mod:!1},extra:{userColor:a,messageId:`${F()}`}};o.emit("command",r)},1e3*s+1e4)}}function F(){return`${Math.floor(Math.random()*1e9)}`}const{twitch_channel:he,twitch_oauth:pe,twitch_username:fe}=_authConfig,ke="ws://irc-ws.chat.twitch.tv:80",x=new de(ke,{username:fe,authToken:pe,channel:he});window.addEventListener("load",()=>{let o="userList";_settings.testMode&&(console.log("Test mode enabled"),o="testUserList");const e=new ee(o);e.render(),x.on("command",t=>{const{user:s,command:n,message:a,flags:r,extra:c}=t,i=e.chatHandler(s,n,a,r,c);i.error?console.error(i.message):x.say(i.message,c.messageId)}),x.on("oauthError",()=>{se()}),x.on("oauthSuccess",()=>{re()}),x.connect(),_settings.testMode&&me(x)})})();
